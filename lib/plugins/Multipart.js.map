{"version":3,"sources":["../../src/plugins/Multipart.js"],"names":["Plugin","require","UppySocket","Utils","module","exports","core","opts","type","id","title","defaultOptions","fieldName","responseUrlFieldName","bundle","handleUpload","bind","upload","file","current","total","log","resolve","reject","formPost","FormData","append","data","Object","keys","meta","forEach","item","xhr","XMLHttpRequest","addEventListener","ev","lengthComputable","emitter","emit","uploader","bytesUploaded","loaded","bytesTotal","target","status","resp","JSON","parse","response","uploadURL","name","open","endpoint","send","on","fileID","abort","uploadRemote","fetch","remote","url","method","credentials","headers","body","stringify","size","fieldname","then","res","statusText","json","token","host","getSocketHost","socket","progressData","emitSocketProgress","close","selectForUpload","files","length","filesForUpload","progress","uploadStarted","isRemote","push","i","parseInt","getState","bus","once","install","addUploader","uninstall","removeUploader"],"mappings":"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","file":"Multipart.js","sourcesContent":["const Plugin = require('./Plugin')\nconst UppySocket = require('../core/UppySocket')\nconst Utils = require('../core/Utils')\n\nmodule.exports = class Multipart extends Plugin {\n  constructor (core, opts) {\n    super(core, opts)\n    this.type = 'uploader'\n    this.id = 'Multipart'\n    this.title = 'Multipart'\n\n    // Default options\n    const defaultOptions = {\n      fieldName: 'files[]',\n      responseUrlFieldName: 'url',\n      bundle: true\n    }\n\n    // Merge default options with the ones set by user\n    this.opts = Object.assign({}, defaultOptions, opts)\n\n    this.handleUpload = this.handleUpload.bind(this)\n  }\n\n  upload (file, current, total) {\n    this.core.log(`uploading ${current} of ${total}`)\n    return new Promise((resolve, reject) => {\n      // turn file into an array so we can use bundle\n      // if (!this.opts.bundle) {\n      //   files = [files[current]]\n      // }\n\n      // for (let i in files) {\n      //   formPost.append(this.opts.fieldName, files[i])\n      // }\n\n      const formPost = new FormData()\n      formPost.append(this.opts.fieldName, file.data)\n\n      Object.keys(file.meta).forEach((item) => {\n        // console.log(file.meta, file.meta[item])\n        formPost.append(item, file.meta[item])\n      })\n\n      const xhr = new XMLHttpRequest()\n\n      xhr.upload.addEventListener('progress', (ev) => {\n        if (ev.lengthComputable) {\n          this.core.emitter.emit('core:upload-progress', {\n            uploader: this,\n            id: file.id,\n            bytesUploaded: ev.loaded,\n            bytesTotal: ev.total\n          })\n        }\n      })\n\n      xhr.addEventListener('load', (ev) => {\n        if (ev.target.status >= 200 && ev.target.status < 300) {\n          const resp = JSON.parse(xhr.response)\n          const uploadURL = resp[this.opts.responseUrlFieldName]\n\n          this.core.emitter.emit('core:upload-success', file.id, resp, uploadURL)\n\n          if (uploadURL) {\n            this.core.log(`Download ${file.name} from ${file.uploadURL}`)\n          }\n\n          return resolve(file)\n        } else {\n          this.core.emitter.emit('core:upload-error', file.id, xhr)\n          return reject('Upload error')\n        }\n\n        // var upload = {}\n        //\n        // if (this.opts.bundle) {\n        //   upload = {files: files}\n        // } else {\n        //   upload = {file: files[current]}\n        // }\n      })\n\n      xhr.addEventListener('error', (ev) => {\n        this.core.emitter.emit('core:upload-error', file.id)\n        return reject('Upload error')\n      })\n\n      xhr.open('POST', this.opts.endpoint, true)\n      xhr.send(formPost)\n\n      this.core.emitter.on('core:upload-cancel', (fileID) => {\n        if (fileID === file.id) {\n          xhr.abort()\n        }\n      })\n\n      this.core.emitter.on('core:cancel-all', () => {\n        // const files = this.core.getState().files\n        // if (!files[file.id]) return\n        xhr.abort()\n      })\n\n      this.core.emitter.emit('core:upload-started', file.id)\n    })\n  }\n\n  uploadRemote (file, current, total) {\n    return new Promise((resolve, reject) => {\n      fetch(file.remote.url, {\n        method: 'post',\n        credentials: 'include',\n        headers: {\n          'Accept': 'application/json',\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify(Object.assign({}, file.remote.body, {\n          endpoint: this.opts.endpoint,\n          size: file.data.size,\n          fieldname: this.opts.fieldName\n        }))\n      })\n      .then((res) => {\n        if (res.status < 200 && res.status > 300) {\n          return reject(res.statusText)\n        }\n\n        this.core.emitter.emit('core:upload-started', file.id)\n\n        res.json().then((data) => {\n          const token = data.token\n          const host = Utils.getSocketHost(file.remote.host)\n          const socket = new UppySocket({ target: `${host}/api/${token}` })\n\n          socket.on('progress', (progressData) => Utils.emitSocketProgress(this, progressData, file))\n\n          socket.on('success', (data) => {\n            this.core.emitter.emit('core:upload-success', file.id, data)\n            socket.close()\n            return resolve()\n          })\n        })\n      })\n    })\n  }\n\n  selectForUpload (files) {\n    if (Object.keys(files).length === 0) {\n      this.core.log('no files to upload!')\n      return\n    }\n\n    const filesForUpload = []\n    Object.keys(files).forEach((file) => {\n      if (!files[file].progress.uploadStarted || files[file].isRemote) {\n        filesForUpload.push(files[file])\n      }\n    })\n\n    filesForUpload.forEach((file, i) => {\n      const current = parseInt(i, 10) + 1\n      const total = filesForUpload.length\n\n      if (file.isRemote) {\n        this.uploadRemote(file, current, total)\n      } else {\n        this.upload(file, current, total)\n      }\n    })\n\n    //   if (this.opts.bundle) {\n    //     uploaders.push(this.upload(files, 0, files.length))\n    //   } else {\n    //     for (let i in files) {\n    //       uploaders.push(this.upload(files, i, files.length))\n    //     }\n    //   }\n  }\n\n  handleUpload () {\n    this.core.log('Multipart is uploading...')\n    const files = this.core.getState().files\n\n    this.selectForUpload(files)\n\n    return new Promise((resolve) => {\n      this.core.bus.once('core:upload-complete', resolve)\n    })\n  }\n\n  install () {\n    this.core.addUploader(this.handleUpload)\n  }\n\n  uninstall () {\n    this.core.removeUploader(this.handleUpload)\n  }\n}\n"]}